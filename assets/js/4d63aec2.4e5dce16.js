"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4513],{3905:(e,t,r)=>{r.d(t,{Zo:()=>m,kt:()=>h});var a=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var l=a.createContext({}),p=function(e){var t=a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},m=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),u=p(r),d=n,h=u["".concat(l,".").concat(d)]||u[d]||c[d]||o;return r?a.createElement(h,s(s({ref:t},m),{},{components:r})):a.createElement(h,s({ref:t},m))}));function h(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,s=new Array(o);s[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[u]="string"==typeof e?e:n,s[1]=i;for(var p=2;p<o;p++)s[p]=r[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,r)}d.displayName="MDXCreateElement"},1846:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var a=r(7462),n=(r(7294),r(3905));const o={sidebar_position:7},s="Custom Streams",i={unversionedId:"stream-basics/custom_streams",id:"stream-basics/custom_streams",title:"Custom Streams",description:'If you have been following the guides, now you know how to create streams, how to compose them together, and everything, however, what if you want to change the core behaviour of the stream, how do you do it? Well, turns out, there are no "custom streams" really, it\'s all just composition.',source:"@site/docs/stream-basics/custom_streams.md",sourceDirName:"stream-basics",slug:"/stream-basics/custom_streams",permalink:"/langstream/docs/stream-basics/custom_streams",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/stream-basics/custom_streams.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Error Handling",permalink:"/langstream/docs/stream-basics/error_handling"},next:{title:"LLMs",permalink:"/langstream/docs/llms/"}},l={},p=[{value:"Next Steps",id:"next-steps",level:2}],m={toc:p},u="wrapper";function c(e){let{components:t,...r}=e;return(0,n.kt)(u,(0,a.Z)({},m,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"custom-streams"},"Custom Streams"),(0,n.kt)("p",null,"If you have been following the guides, now you know how to create streams, how to compose them together, and everything, however, what if you want to change the core behaviour of the stream, how do you do it? Well, turns out, ",(0,n.kt)("strong",{parentName:"p"},'there are no "custom streams" really'),", it's all just composition."),(0,n.kt)("p",null,"For example, let's say you want a stream that retries on error, using the ",(0,n.kt)("a",{parentName:"p",href:"https://pypi.org/project/retry/"},(0,n.kt)("inlineCode",{parentName:"a"},"@retry"))," library annotation, you can simply create a function that wraps the stream to be retried:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'from langstream import Stream\nfrom retry import retry\nfrom typing import TypeVar\n\nT = TypeVar("T")\nU = TypeVar("U")\n\ndef retriable(stream: Stream[T, U]) -> Stream[T, U]:\n    @retry(tries=3)\n    def call_wrapped_stream(input: T):\n        return stream(input)\n\n    return Stream[T, U]("RetriableStream", call_wrapped_stream)\n')),(0,n.kt)("p",null,"And use it like this:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'from langstream import collect_final_output\n\nattempts = 0\n\ndef division_by_attempts(input: int):\n    global attempts\n    attempts += 1\n    return input / (attempts - 1)\n\nstream = retriable(\n  Stream[int, float]("BrokenStream", division_by_attempts)\n).map(lambda x: x + 1)\n\nawait collect_final_output(stream(25))\n#=> [26]\n')),(0,n.kt)("p",null,"This stream will first divide by zero, causing a ",(0,n.kt)("inlineCode",{parentName:"p"},"ZeroDivisionError"),", but thanks to our little ",(0,n.kt)("inlineCode",{parentName:"p"},"retriable")," wrapper, it will try again an succeed next time, returning ",(0,n.kt)("inlineCode",{parentName:"p"},"26"),"."),(0,n.kt)("p",null,"So that's it, because streams are just input and output, a simple function will do, if you want to write a class to fit more the type system and be more pythonic, you also can, and the only method you need to override is ",(0,n.kt)("inlineCode",{parentName:"p"},"__init__"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'class RetriableStream(Stream[T, U]):\n    def __init__(self, stream: Stream[T, U], tries=3):\n        @retry(tries=tries)\n        def call_wrapped_stream(input: T):\n            return stream(input)\n\n        super().__init__("RetriableStream", call_wrapped_stream)\n')),(0,n.kt)("p",null,"This will work exactly the same as the function:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'attempts = 0\n\nstream = RetriableStream(\n  Stream[int, float]("BrokenStream", division_by_attempts)\n).map(lambda x: x + 1)\n\nawait collect_final_output(stream(25))\n#=> [26]\n')),(0,n.kt)("p",null,"As a proof that this is enough, take a look at ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/rogeriochaves/langstream/blob/main/langstream/contrib/llms/open_ai.py#L26"},"how the OpenAICompletionStream is implemented"),", it's a simple wrapper of OpenAI's API under ",(0,n.kt)("inlineCode",{parentName:"p"},"__init__")," and that's it."),(0,n.kt)("h2",{id:"next-steps"},"Next Steps"),(0,n.kt)("p",null,"This concludes the guides for Stream Basics, congratulations! On the next steps, we are going to build some real application with real LLMs, stay tuned!"))}c.isMDXComponent=!0}}]);